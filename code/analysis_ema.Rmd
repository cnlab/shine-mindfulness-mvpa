---
title: "EMA intervention analyses"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.path = "figs_ema/", dpi = 300,
                      colormodel = "cmyk", fig.width=7, fig.height=5)
options(scipen = 999)
```

This code reproduces the EMA intervention analyses reported in the following manuscript:

[Cosme, D., Helion, C., et al. (2023) Mindful attention to alcohol can reduce cravings in the moment and consumption in daily life]()

# load packages
```{r}
library(pacman)
pacman::p_load(tidyverse, brms, ggeffects, kableExtra, tidybayes, install = TRUE)
```

# define aesthetics
```{r}
palette = c("#e64626", "#1985a1", "#4c5c68", "#FAC748")

plot_aes = theme_minimal() +
  theme(legend.position = "top",
        legend.text = element_text(size = 16),
        text = element_text(size = 18, family = "Futura Medium"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        axis.ticks.y = element_blank())
```

# define functions
```{r}
make_table = function(data) {
    data %>%
      broom.mixed::tidy(conf.int = TRUE) %>%
      filter(effect == "fixed") %>%
      mutate(term = gsub("\\(Intercept\\)", "intercept", term),
             term = gsub("regulation_expression", "signature expression", term),
             term = gsub("active_weekon", "intervention week (active)", term),
             term = gsub("active_weekoff", "intervention week (control)", term),
             term = gsub("signal_count", "signal", term),
             term = gsub(":", " x ", term),
             `b [95% CI]` = sprintf("%.2f [%.2f, %.2f]", estimate, conf.low, conf.high)) %>%
      select(term, `b [95% CI]`) %>%
      knitr::kable(digits = 2)
}
```

# load data
```{r}
merged = read.csv("../data/task_neuro_data.csv", stringsAsFactors = FALSE)
ema = read.csv("../data/ema.csv")
```

## merge and prep for modeling
```{r}
between = merged %>%
  filter(condition == "mindful attention") %>%
  select(pID, dot, trial_cond, condition) %>%
  group_by(pID, trial_cond, condition) %>%
  summarize(dot_between = mean(dot, na.rm = TRUE)) %>%
  group_by(trial_cond) %>%
  mutate(dot_between_c = scale(dot_between, scale = FALSE, center = TRUE)) %>%
  mutate(sd_dot = sd(dot_between, na.rm = TRUE),
         dot_between_std = dot_between_c / sd_dot) %>%
  select(pID, condition, trial_cond, dot_between_std) %>%
  mutate(trial_cond = sprintf("%s_expression", trial_cond)) %>%
  spread(trial_cond, dot_between_std)

ema_within = ema %>%
  left_join(., between)
```

# descriptives {.tabset}
## weekly drinking
```{r}
ema_within %>%
  mutate(week = ifelse(signal_count %in% c(1:14), 1,
                ifelse(signal_count %in% c(15:28), 2,
                ifelse(signal_count %in% c(29:42), 3, 4)))) %>%
  group_by(pID, week) %>%
  summarize(sum = sum(drinks_number_noc, na.rm = TRUE)) %>%
  ungroup() %>%
  summarize(min = min(sum),
            max = max(sum),
            mean = mean(sum),
            sd = sd(sum)) %>%
  kable(digits = 1, format = "pandoc")
```

# effectiveness and individual differences: experience sampling intervention analyses (H3-4) {.tabset}

`r emo::ji("check")` H3a: Active intervention weeks will increase participantsâ€™ self-reported mindful attention to alcohol 

`r emo::ji("check")` H3b: Mindful attention will be positively associated with decreased alcohol consumption

`r emo::ji("check")` H3c: There will be an indirect effect of intervention-related change in alcohol consumption through greater mindful attention to alcohol

`r emo::ji("check")` H4a: People with stronger signature expression would show greater increases in mindful attention to alcohol on active intervention weeks compared to control weeks

`r emo::ji("check")` H4b: People with stronger signature expression would show more negative relationships between mindful attention to alcohol and alcohol consumption 

```{r}
prior = c(prior(normal(0, 1), class=b))
```

## run model
```{r, cache = FALSE, include = FALSE}
fm = bf(mindful_response ~ active_week * regulation_expression + (0 + active_week |i| pID)) +
  bf(drinks_number ~ active_week + regulation_expression * mindful_response + (0 + active_week + mindful_response |i| pID)) +
  set_rescor(FALSE)
          
fit_brm_m = brm(
  fm,
  data  = ema_within,
  cores = 4,
  thin  = 4,
  seed  = 6523,
  control = list(adapt_delta = .99, max_treedepth = 15),
  prior = prior
)
```

## table
```{r}
fit_brm_m %>%
  broom.mixed::tidy(conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  mutate(term = gsub("\\(Intercept\\)", "intercept", term),
         term = gsub("regulation_expression", "signature expression", term),
         term = gsub("active_weekon", "intervention week (active)", term),
         term = gsub("active_weekoff", "intervention week (control)", term),
         term = gsub("mindful_response", "mindful response", term),
         response = gsub("mindfulscale", "mindful response", response),
         response = gsub("drinksnumber", "number of drinks", response),
         term = gsub(":", " x ", term),
         `b [95% CI]` = sprintf("%.2f [%.2f, %.2f]", estimate, conf.low, conf.high)) %>%
  rename("outcome" = response) %>%
  select(outcome, term, `b [95% CI]`) %>%
  arrange(outcome) %>%
  knitr::kable(digits = 2, format = "pandoc")
```

## indirect effect test
```{r}
hypothesis(
  fit_brm_m,
  'b_drinksnumber_mindful_response * b_mindfulresponse_active_weekon + cor_pID__mindfulresponse_active_weekon__drinksnumber_active_weekon * sd_pID__mindfulresponse_active_weekon * sd_pID__drinksnumber_mindful_response = 0',
  class = NULL,
  seed  =  6523
)
```

## summary
```{r}
summary(fit_brm_m)
```

## plots {.tabset}
### mindful responses by intervention week
```{r}
slopes_within = ema_within %>%
  select(pID, active_week, mindful_response) %>%
  rename("x" = active_week,
         "predicted" = mindful_response) %>%
  mutate(x = recode(x, "on" = "active", "off" = "control"),
         x = factor(x, levels = c("control", "active"))) %>%
  group_by(pID, x) %>%
  summarize(predicted = mean(predicted, na.rm = TRUE))
  
predicted = ggeffects::ggpredict(fit_brm_m, terms = c("active_week", "regulation_expression [0, 1]")) %>%
  data.frame() %>%
  mutate(x = recode(x, "on" = "active", "off" = "control"),
         group = recode(group, "0" = "mean", "1" = "+1 SD"),
         x = factor(x, levels = c("control", "active")))

(plot_response = predicted %>%
  filter(response.level == "mindfulresponse") %>%
  ggplot(aes(x, predicted)) +
  geom_line(data = slopes_within, aes(x, predicted, group = pID), alpha = .3) +
  geom_line(aes(group = group, color = group), size = 2, , position = position_dodge(.1)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high, color = group), size = 2, linewidth = 2, position = position_dodge(.1)) +
  scale_x_discrete(expand = c(.1, .1)) +
  scale_color_manual(values = palette, name = "signature expression") +
  labs(x = "\nintervention week", y = "within-person mindful response (SD)\n") +
  plot_aes)
```

### alchol consumption ~ mindful responses
```{r}
vals = seq(-2,2,.2)

points_within = ema_within %>%
  select(pID, drinks_number, mindful_response) %>%
  rename("x" = mindful_response,
         "predicted" = drinks_number)

predicted = ggeffects::ggpredict(fit_brm_m, terms = c("mindful_response", "regulation_expression [0, 1]")) %>%
  data.frame() %>%
  mutate(group = recode(group, "0" = "mean", "1" = "+1 SD"))

(plot_alcohol = predicted %>%
  filter(response.level == "drinksnumber") %>%
  ggplot(aes(x, predicted)) +
  geom_point(data = points_within, alpha = .2, size = 2) +
  geom_line(aes(group = group, color = group), size = 2) +
  geom_ribbon(aes(fill = group, ymin = conf.low, ymax = conf.high), size = 2, alpha = .4) +
  scale_color_manual(values = palette, name = "signature expression") +
  scale_fill_manual(values = palette, name = "signature expression") +
  labs(x = "\nwithin-person mindful response (SD)", y = "within-person number of drinks\n") +
  plot_aes)
```

### combined
```{r, fig.width=11.25, fig.height=5.5}
ggpubr::ggarrange(plot_response, plot_alcohol, nrow = 1, common.legend = TRUE)
```

# supplementary analyses {.tabset}

Test craving as the mediator instead of mindful responses to alcohol

## run model
```{r, cache = FALSE, include = FALSE}
fm = bf(craving_previous ~ active_week * regulation_expression + (0 + active_week |i| pID)) +
  bf(drinks_number ~ active_week + regulation_expression * craving_previous + (0 + active_week + craving_previous |i| pID)) +
  set_rescor(FALSE)
          
fit_brm_c = brm(
  fm,
  data  = ema_within,
  cores = 4,
  thin  = 4,
  seed  = 6523,
  control = list(adapt_delta = .99, max_treedepth = 15),
  prior = prior
)
```

## table
```{r}
fit_brm_c %>%
  broom.mixed::tidy(conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  mutate(term = gsub("\\(Intercept\\)", "intercept", term),
         term = gsub("regulation_expression", "signature expression", term),
         term = gsub("active_weekon", "intervention week (active)", term),
         term = gsub("active_weekoff", "intervention week (control)", term),
         term = gsub("craving_previous", "craving rating", term),
         response = gsub("cravingprevious", "craving rating", response),
         response = gsub("drinksnumber", "number of drinks", response),
         term = gsub(":", " x ", term),
         `b [95% CI]` = sprintf("%.2f [%.2f, %.2f]", estimate, conf.low, conf.high)) %>%
  rename("outcome" = response) %>%
  select(outcome, term, `b [95% CI]`) %>%
  arrange(outcome) %>%
  knitr::kable(digits = 2, format = "pandoc")
```

## indirect effect test
```{r}
hypothesis(
  fit_brm_c,
  'b_drinksnumber_craving_previous * b_cravingprevious_active_weekon + cor_pID__cravingprevious_active_weekon__drinksnumber_active_weekon * sd_pID__cravingprevious_active_weekon * sd_pID__drinksnumber_craving_previous = 0',
  class = NULL,
  seed  =  6523
)
```

## summary
```{r}
summary(fit_brm_c)
```


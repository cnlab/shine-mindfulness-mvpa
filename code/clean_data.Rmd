---
title: "Clean data"
author: ""
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
options(scipen = 999)
```

This code cleans the data for the following manuscript:

[Mindful attention to alcohol can reduce cravings in the moment and consumption in daily life]()

# load packages
```{r}
library(pacman)
pacman::p_load(tidyverse, lubridate, install = TRUE)
```

# load and tidy data {.tabset}
* remove trials missing stimulus information
  * the following participants had technical errors during all mindful attention trials: sub-MURIP012, sub-MURIP063, sub-MURIP078
* remove trials in which the mean signal intensity of the brain map is +/- 3 SDs from the mean

## task
```{r}
task_data = read.csv("../data_raw/task/cuereact_all062920.csv", stringsAsFactors = FALSE) %>%
  filter(grepl("rating", trial_type)) %>%
  select(pID, block_num, trial_num, trial_type, resp, rt, stim) %>%
  mutate(trial_cond = ifelse(grepl("friend3|friend4", trial_type), "regulation",
                      ifelse(grepl("friend1|friend2", trial_type), "up-regulation",
                      ifelse(grepl("mindful", trial_type), "regulation",
                      ifelse(grepl("nonalc", trial_type), "non-alcohol reactivity",
                      ifelse(grepl("rating_alc_react", trial_type), "reactivity", NA))))),
         trial_cond = factor(trial_cond, levels = c("non-alcohol reactivity", "reactivity", "regulation", "up-regulation"))) %>%
  rename("stimulus" = stim) %>%
  filter(!is.na(stimulus))

task_conditions = task_data %>%
  select(pID, trial_type) %>%
  unique() %>%
  filter(grepl("friend|mindful", trial_type) | pID %in% c("sub-MURIP012", "sub-MURIP063", "sub-MURIP078")) %>%
  mutate(condition = ifelse(grepl("friend", trial_type), "perspective-taking", "mindful attention")) %>%
  select(-trial_type) %>%
  unique()

task_data_all = task_data %>%
  left_join(., task_conditions) %>%
  mutate(condition = ifelse(is.na(condition), "control", condition),
         trial_cond = factor(trial_cond, c("non-alcohol reactivity", "reactivity", "regulation", "up-regulation")))
```

## dots
```{r}
file_dir = "../data_raw/dots"
file_pattern = "sub.*"
file_list = list.files(file_dir, pattern = file_pattern)

dots_tmp = data.frame()

for (file in file_list) {
  tmp = tryCatch(read.table(file.path(file_dir,file), fill = TRUE, header = TRUE, sep = ",") %>%
                    extract(file, c("pID", "beta"), ".*(sub-MURIC[0-9]{3}|sub-MURIP[0-9]{3})/(beta_[0-9]{4}).nii") %>%
                    mutate(stimulus = as.character(stimulus)), error = function(e) message(file))
  
  dots_tmp = rbind(dots_tmp, tmp)
  rm(tmp)
}

dots = dots_tmp %>%
  left_join(., task_conditions) %>%
  mutate(condition = ifelse(is.na(condition), "control", condition)) %>%                                              
  group_by(pID) %>%
  filter(!stimulus == "nan") %>%
  mutate(sd3_signal = 3 * sd(mean_signal, na.rm = TRUE),
         grand_mean_signal = mean(mean_signal, na.rm = TRUE),
         outlier = ifelse(mean_signal > grand_mean_signal + sd3_signal, 1,
                   ifelse(mean_signal < grand_mean_signal - sd3_signal, 1, 0))) %>%
  select(-sd3_signal, -grand_mean_signal) %>%
  filter(!outlier == 1)
```

## classifier data
```{r}
classifier_data = read.csv("../data_raw/mvpa/logistic_stats.csv", stringsAsFactors = FALSE) %>%
  rename("pID" = subjectID) %>%
    mutate(predicted_factor = ifelse(predicted > .5, "regulate", "react"),
           predicted_factor = as.factor(predicted_factor),
           actual_factor = ifelse(actual == 1, "regulate", "react"),
           actual_factor = as.factor(actual_factor))
```

## post-task confidence ratings
```{r}
ratings = read.csv("../data_raw/task/post_scan_ratings.csv", stringsAsFactors = FALSE) %>%
  select(DistributionChannel, pID, mindful2) %>%
  filter(DistributionChannel == "anonymous" & grepl("muri|MURI", pID)) %>%
  extract(pID, c("pID", "number"), "(.*)([0-9]{3})") %>%
  mutate(pID = ifelse(pID %in% c("muri", "MURI"), "MURIP", pID),
         pID = sprintf("sub-%s%s", toupper(pID), number),
         confidence_rating = scale(as.numeric(mindful2), center = TRUE, scale = TRUE)) %>%
  select(-number, -mindful2, -DistributionChannel)
```

## pre-scan trait mindfulness scores on the MAAS
```{r}
maas = read.csv("../data_raw/prescan/muri_prescan_scored.csv", stringsAsFactors = FALSE) %>%
  rename("pID" = SID) %>%
  mutate(pID = gsub("muric", "sub-MURIC", pID),
         pID = gsub("muri", "sub-MURIP", pID),
         MAAS_mean = scale(MAAS_mean, center = TRUE, scale = TRUE)) %>%
  select(pID, MAAS_mean)
```

## EMA data
```{r}
ema_all = read.csv("../data_raw/ema/SHINE_EMA_May19_2020.csv", stringsAsFactors = FALSE) %>%
  mutate(shineid = tolower(SHINEID)) %>% #make ids lowercase 
  filter(!shineid == "muri035") #remove 1ppt with no completion due to technical app difficulties 
  
ema = ema_all %>%
  filter(Condition == "mindful") %>% # subset participants in the mindfulness condition
  select(shineid, Notification.Time, contains("signal"), Session.Name, HadAlcohol, contains("Num_"), contains("Craving"), Alc_React_Mindful, -Num_Caffeine, -Num_Water) %>%
  filter(!is.na(Notification.Time)) %>%
  mutate(pID = shineid,
         pID = gsub("muric", "sub-MURIC", pID),
         pID = gsub("muri", "sub-MURIP", pID),
         active_week = ifelse(grepl("PROMPTA", Session.Name), "off",
                        ifelse(grepl("PROMPTB|PROMPTC", Session.Name), "on", NA)),
         Notification.Time = mdy_hm(Notification.Time)) %>% 
  extract(Notification.Time, "date", "(.*) .*", remove = FALSE) %>%
  group_by(pID) %>%
  fill(active_week, .direction = "down") %>% #by grouping by participant and filling down, this removes the first morning reports and codes the first morning of switch (e.g., off --> on) as the previous condition because they alcohol report (and lagged craving) are from the previous night
  arrange(pID, Notification.Time) %>%
  group_by(pID) %>%
  mutate(craving_previous = lag(Craving_Alc)) %>% #lag craving before selecting signals with alcohol prompts 
  filter(grepl("Morning|Evening", Session.Name)) %>% #select only alcohol prompts
  mutate(drinks_number_noc = ifelse(HadAlcohol == 1, Num_Beer + Num_Wine + Num_Liquor, #sum drinks if HadAlcohol = 1
                                    ifelse(HadAlcohol == 0, 0, NA)),
         drinks_number = scale(drinks_number_noc, center = TRUE, scale = FALSE), #center within-person but don't scale to keep interpretable unites
         mindful_response = scale(Alc_React_Mindful, center = TRUE, scale = TRUE), #center and scale within-person
         craving = scale(Craving_Alc, center = TRUE, scale = TRUE), #center and scale within-person
         craving_previous = scale(craving_previous, center = TRUE, scale = TRUE), #center and scale within-person
         signal_count = row_number()) %>% 
  select(pID, Notification.Time, date, Session.Name, signal_count, everything(), -shineid)
```

## merge and prep for modeling
* filter out motion exclusions: sub-MURIC303
* filter out reactivity to non-alcoholic beverage trials
* create disaggregated_mindful dataset
  * `dot_within_std` = within-person centered level-1 signature expression variable; standardized across participants
  * `dot_between_std` = grand-mean centered level-2 signature expression variable; standardized across participants
* due to a technical errror, the following participants are missing behavioral data from mindful attention trials: sub-MURIP063, sub-MURIP078, sub-MURIP012

```{r}
merged = task_data_all %>%
  full_join(., dots) %>%
  filter(!pID == "sub-MURIC303") %>%
  filter(trial_cond %in% c("reactivity", "regulation")) %>%
  mutate(trial_cond = as.factor(as.character(trial_cond)))

between = merged %>%
  select(pID, dot, trial_cond, condition) %>%
  group_by(pID, trial_cond, condition) %>%
  summarize(dot_between = mean(dot, na.rm = TRUE)) %>%
  group_by(condition) %>%
  mutate(sd_dot = sd(dot_between, na.rm = TRUE),
         dot_between_std_noc = dot_between / sd_dot) %>%
  select(-sd_dot)

within = merged %>%
  select(pID, block_num, trial_num, dot, condition, trial_cond) %>%
  group_by(pID, condition) %>%
  mutate(dot_within_c = scale(dot, scale = FALSE, center = TRUE)) %>%
  group_by(condition) %>%
  mutate(sd_dot = sd(dot_within_c, na.rm = TRUE),
         dot_within_std = dot_within_c / sd_dot) %>%
  select(-sd_dot)

disaggregated = merged %>%
  left_join(., between, by = c("pID", "condition", "trial_cond")) %>%
  left_join(., within, by = c("pID", "condition", "trial_num", "block_num", "trial_cond", "dot")) %>%
  filter(trial_cond %in% c("reactivity", "regulation"))
```

# write csvs 
```{r}
write.csv(merged, "../data/task_neuro_data.csv", row.names = FALSE)
write.csv(disaggregated, "../data/disaggregated_data.csv", row.names = FALSE)
write.csv(classifier_data, "../data/classifier_data.csv", row.names = FALSE)
write.csv(ratings, "../data/ratings.csv", row.names = FALSE)
write.csv(maas, "../data/MAAS.csv", row.names = FALSE)
write.csv(ema, "../data/ema.csv", row.names = FALSE)
```

